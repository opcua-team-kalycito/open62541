#!/bin/bash
#------------------------------------------------------------------------------
# Copyright (C) 2021 Kalycito Infotech Private Limited
# Author: Kalycito Infotech Private Limited
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# -----------------------------------------------------------------------------

###############################################################################
# Global Variable - constant                                                  #
###############################################################################
#Directory in which the file delayed_packets.txt is generated by the
# pubsub application
GENLATENCYDIR=/mnt/ramdisk/

if test -s $GENLATENCYDIR/delayed_packets.txt; then
    delayedPacketsFile=$GENLATENCYDIR/delayed_packets.txt
    #Get the maximum value of latency, missed and repeated counters by
    # taking its particular column, descend sorting and taking the first value
    missedCounterSub=`tail -1 $delayedPacketsFile | \
                      tr -s " " | \
                      cut -d"," -f1`
    repeatedCounterSub=`tail -1 $delayedPacketsFile | \
                        tr -s " " | \
                        cut -d"," -f2`

    #To delete the text file when the application stops running
    pidOfPubSubApp=`ps -aux | grep "[p]ubsub_TSN" | awk '{print $2}'`
    if test -z "$pidOfPubSubApp"
    then
        sudo bash -c "rm /usr/local/src/open62541_subscriber_countermiss.txt"
        sudo bash -c "rm $delayedpacketsFile"
    else
        #Write the missed and repeated counters values to open62541_subscriber_countermiss.txt text file which will be used by Munin scripts
        sudo bash -c "echo $missedCounterSub $repeatedCounterSub > /usr/local/src/open62541_subscriber_countermiss.txt"
    fi
fi

