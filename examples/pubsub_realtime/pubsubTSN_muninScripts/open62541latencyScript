#!/bin/bash

#Directory in which the latency csv files are generated by the pubsub application
GENLATENCYDIR=/home/svradmin/INTEL_OPCUA_SRC/build/
#Directory to store the csv files. It is currently not used as the csv files are being deleted once it is calculated. (In future a ext hard disk directory or mounted nfs directory can be used)
CSVSTOREDIR=/

#Test whether the csv files are generated in the directory. If not, remove the open62541_pubsub_maxlatency.txt text file which lets the Munin knows maximum latency value, repeated and missed counters
for i in $GENLATENCYDIR/latency_*.csv
do
    if test -f $i
    then
        break
    else
        if test -f /usr/local/src/open62541_pubsub_maxlatency.txt
        then
            rm /usr/local/src/open62541_pubsub_maxlatency.txt #Remove the file if latency generation stopped (Assuming the applications are stopped)
        fi
        exit 0
    fi
done

max=0
for i in $GENLATENCYDIR/latency_*.csv
do
    #Get the maximum value of latency, missed and repeated counters by taking its particular column, descend sorting and taking the first value
    tmpMaxLatValue=`cat $i | cut -d, -f2 | tr -d '.' | sort -nrk1,1 | head -1`
    missedCounter=`cat $i | cut -d, -f3 | tr -d '.' | sort -nrk1,1 | head -1`
    repeatedCounter=`cat $i | cut -d, -f4 | tr -d '.' | sort -nrk1,1 | head -1`
    if test $tmpMaxLatValue -gt $max
    then
        max=$tmpMaxLatValue
    fi
    # mv $i $CSVSTOREDIR # Move the latecy files to the directory where it can be stored
    rm $i #Removing csv files after the computation
done

#Write the maximum latency, missed and repeated counters values to open62541_pubsub_maxlatency.txt text file which will be used by Munin scripts
echo "Max_latency_withMCnRC $max $missedCounter $repeatedCounter" > /usr/local/src/open62541_pubsub_maxlatency.txt

